## 项目架构评审复核

### 1. 复核目标与范围
- 任务：核实既有《项目架构评审》报告的事实依据，补充需要在 README 中固化的“前端统一使用 `clientLogger`”约定。
- 代码快照：基于 `D:\Cursor project\mksaas_template-main` 2025-11-24 11:00 左右版本，包含最新的 `client-logger.ts` 引入及 AI/credits/payment/user-lifecycle 改造。
- 样本：`src/app`, `src/lib`, `src/payment`, `src/credits`, `src/ai`, `src/hooks`, `src/components`, `src/actions`、`src/lib/server` 关键用例以及 `docs/*` 结构说明。

### 2. 关键结论复核
| 维度 | 报告结论 | 代码事实 | 评估 |
| --- | --- | --- | --- |
| 可维护性 | 分层清晰，`auth/payment/credits/ai` 各自独立，部分“胖文件” | `src/lib/auth.ts`, `src/payment/services/stripe-payment-service.ts`, `src/credits/services/credit-ledger-service.ts`, `src/ai/text/utils/analyze-content-handler.ts` 实际均维持模块边界，但 auth/analyzer 文件 >400 行 | 结论成立；需持续监控胖文件 |
| 复用性 | user lifecycle hooks、PaymentProvider、CreditsGateway 可迁移 | `src/lib/user-lifecycle/*`, `src/payment/index.ts`, `src/credits/services/credit-ledger-service.ts` 通过接口导出，UI 层仅调用 hooks/actions | 成立 |
| 耦合度 | 绝大多数 infra 依赖集中在 service/provider 层，auth.ts 仍为耦合热点 | Better Auth 通过 `databaseHooks` 派发到 `handleAuthUserCreated`，payment 单例注入 Stripe/Credits/Notification；UI 不直接接触 ORM 或 SDK | 成立，热点定位准确 |
| 关键业务流 | A 鉴权、B 支付+credits、C AI 内容分析、D Admin 后台数据链路被正确描述 | 逐条对照 `src/app/api`, `src/actions`, `src/hooks`, `src/lib/server/usecases`，调用顺序与报告一致 | 成立 |

### 3. 复核补充要点
1. **Auth 事件路由**已经存在：`src/lib/auth-domain.ts` + `src/lib/user-lifecycle` 已经将 Better Auth 的 `databaseHooks` 与 credits/newsletter 钩子解耦，报告中“建议增加事件总线”属于已完成项。
2. **BillingService 聚合**已落地：`src/domain/billing` 提供 `DefaultBillingService`，在 server action 与 Stripe webhook 中统一调用，可集中管理 `startSubscriptionCheckout/handleRenewal/grantLifetimePlan` 语义化 API。
3. **AI analyze-content handler** 已拆分为 `analyze-content/{scraper,provider-factory,content-analyzer}.ts`，原 handler 仅作为 orchestrator；后续需补充文档与更多单测。
4. **Plan/Credits 策略**：`websiteConfig.price.plans`、`src/credits/config.ts`、`CreditLedgerService` 共同决定额度，抽象出 `PlanCreditsPolicy` 可降低耦合。
5. **Hooks 责任边界**：`useCurrentPlan` 等 hook 在内部耦合 Query + 业务规则 + UI reshaping，易成为复用障碍，应提炼纯函数承载业务算法。

### 4. 前端日志约定
- 已在 `src/lib/client-logger.ts` 引入统一入口，禁止在组件/Hook 中直接调用 `console.*`。
- 应在 `README.md` 或 `docs/contributing.md` 新增条款：“所有前端日志统一通过 `clientLogger`，Code Review 阶段若发现裸 `console` 需退回修改”。该动作尚未落地，需跟进。

### 5. 后续动作清单
1. 在 README 中补充 “clientLogger ≠ console” 的显式约定，并在 PR 模板/Review checklist 中加入检查项；配合新增的 `NEXT_PUBLIC_ENABLE_PERF_LOGS` 说明性能日志开关。
2. ✅ `BillingService` 聚合已上线，后续需持续补充端到端测试/文档，确保团队了解统一入口。
3. ✅ `analyze-content-handler.ts` 已拆分为 `scraper/provider-factory/content-analyzer`，保持原导出；接下来要完善新模块文档与测试覆盖。
4. 收敛 plan/credits 策略：引入 `PlanCreditsPolicy`，由其读取 `websiteConfig` 并定义注册赠送/月刷新/续费/终身逻辑；`CreditLedgerService` 仅依赖该抽象。
5. 为 `useCurrentPlan` 等复合 Hook 提取共享的 domain helper（例如 `resolveCurrentPlan(subscription, isLifetimeMember, plans)`），并添加针对性测试。

> 结论：原《项目架构评审》在结构、业务流、风险点描述上与现状高度一致。需要更新的只有“Auth 事件总线”建议（实际已完成）与新的前端日志约定文档化要求。其余改进方向（BillingService、AI handler 拆分、PlanPolicy、Hook 解耦）仍属有效建议。

---

## 终身计划限流校验修复（当前任务）

### 背景
- Webhook 中 `grantLifetimePlan` 在 Stripe 事务里执行，但 `UserLifetimeMembershipRepository` 未共享同一事务，存在“付款失败但会员记录写入”与“会员写入失败但付款提交”风险。
- `distributeCreditsToAllUsers` 遇到 `user_lifetime_membership` 时若 `websiteConfig` 缺少对应 price，会直接跳过该用户，导致终身会员断供。
- README 中 cron 示例使用 `POST`，与当前路由（仅 GET）不符。

### 工作计划
1. **BillingService 原子性**
   - 将 `resolveExecutor(input.transaction)` 结果下传给 `UserLifetimeMembershipRepository.upsertMembership`，保证会员记录与付款/积分写入同一事务。
   - 补充针对 `grantLifetimePlan` 的单元测试，验证当传入 `CreditsTransaction` 时仓储接收到同一 executor。
2. **积分派发兜底**
   - 为 `user_lifetime_membership` 批次增加 helper：若 `findPlanByPriceId` 失败或 plan 未启用 lifetime credits，则记录 `warn` 并回退到 `freeUserIds`。
   - 编写单测覆盖 helper：验证 plan 存在时返回 lifetime 列表、plan 缺失时触发 fallback。
3. **README 纠偏**
   - 将 cron 示例改为 `GET`，并在示例下方注明路由仅支持 GET。
4. **质量验证**
   - 运行新增测试，确保修改点有覆盖。

### 终身计划优化（第二阶段）
1. `collectValidLifetimeMemberships` 增强：返回 `invalidMemberships`，仅在调用方统一记录警告，并保持无配置时回退 Free。
2. 引入 `createCachedPlanResolver`（`src/credits/distribute.ts`）提供 priceId→plan 的缓存，供终身/年付两处共用，避免重复解析配置。
3. 新增单测：
   - `collectValidLifetimeMemberships`：校验 invalid list/fallback 逻辑；
   - `createCachedPlanResolver`：验证重复 price 查找只命中一次；
   - `DefaultBillingService` 事务传递单测沿用上一阶段。
