name: Security Scan

on:
  schedule:
    - cron: '0 2 * * 1'
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - 'release/*'
    paths:
      - pnpm-lock.yaml
      - .github/workflows/security-scan.yml
  workflow_dispatch:

permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: bash

jobs:
  security:
    runs-on: ubuntu-latest
    env:
      PNPM_HOME: ~/.local/share/pnpm
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: 20
          pnpm-version: 9
          cache-dependency-path: pnpm-lock.yaml

      - name: Install production dependencies
        run: pnpm install --frozen-lockfile --prod --prefer-offline

      - name: Secret scan (gitleaks)
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Required for organization repos
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: 'true'
          GITLEAKS_ENABLE_SUMMARY: 'false'
        continue-on-error: true

      - name: npm audit (high)
        run: pnpm audit --prod --audit-level high

      - name: OSV scanner
        run: |
          set -euo pipefail
          curl -fsSL https://github.com/google/osv-scanner/releases/download/v2.2.4/osv-scanner_linux_amd64 -o osv-scanner
          chmod +x osv-scanner
          status=0
          if ! ./osv-scanner --lockfile=pnpm-lock.yaml --format sarif --output osv-results.sarif; then
            status=$?
          fi
          if [ "$status" -eq 1 ]; then
            echo "::warning::OSV scanner detected vulnerabilities. Review osv-results.sarif."
          elif [ "$status" -ne 0 ]; then
            exit "$status"
          fi
          rm osv-scanner

      - name: Generate OSV summary
        id: osv_summary
        run: |
          set -euo pipefail
          if [ ! -s osv-results.sarif ]; then
            echo "# OSV Scanner\n\n_Êú™ÁîüÊàêÊä•Âëä„ÄÇ_" | tee osv.md
          else
            jq -r '
              def sev(x):
                if x == "CRITICAL" then "üö® Critical"
                elif x == "HIGH" then "‚ö†Ô∏è High"
                elif x == "MEDIUM" then "‚ö†Ô∏è Medium"
                elif x == "LOW" then "‚ÑπÔ∏è Low"
                else x end;
              def row(r):
                "| " + sev(r.properties.severity // "Unknown") + " | " +
                (r.message.text // "Unknown") + " | " +
                (try r.locations[0].physicalLocation.artifactLocation.uri catch "n/a") + " | " +
                (try r.properties.references[0].url catch "n/a") + " |";
              def table(res):
                if (res | length) == 0 then "_Êú¨Ê¨°Êâ´ÊèèÊú™ÂèëÁé∞ÊºèÊ¥û„ÄÇ_"
                else "| Severity | Package | Location | Advisory |\n| --- | --- | --- | --- |\n" +
                  (res | map(row(.)) | join("\n"))
                end;
              "# OSV Scanner\n\n" + table(.runs[0].results // [])
            ' osv-results.sarif | tee osv.md
          fi
          cat osv.md >> "$GITHUB_STEP_SUMMARY"
          {
            echo 'osv<<EOF'
            cat osv.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
        env:
          CODEQL_ACTION_DISABLE_DEFAULT_DATABASE_UPLOAD: true

      - name: Perform CodeQL analysis
        id: codeql_analyze
        uses: github/codeql-action/analyze@v4
        with:
          upload: false
        env:
          CODEQL_ACTION_DISABLE_DEFAULT_DATABASE_UPLOAD: true

      - name: Generate CodeQL summary
        id: codeql_summary
        env:
          CODEQL_SARIF_DIR: ${{ steps.codeql_analyze.outputs.sarif-output }}
        run: |
          set -euo pipefail
          dir="${CODEQL_SARIF_DIR:-}"
          if [ -z "$dir" ] || [ ! -d "$dir" ]; then
            echo "# CodeQL\n\n_Êú™ÁîüÊàêÊä•Âëä„ÄÇ_" | tee codeql.md
          else
            mapfile -t files < <(find "$dir" -type f -name '*.sarif' -print | sort)
            if [ "${#files[@]}" -eq 0 ]; then
              echo "# CodeQL\n\n_Êú™ÁîüÊàêÊä•Âëä„ÄÇ_" | tee codeql.md
            else
              jq -sr '
                def lvl(x):
                  if x == "error" then "üö® Error"
                  elif x == "warning" then "‚ö†Ô∏è Warning"
                  elif x == "note" then "‚ÑπÔ∏è Note"
                  else x end;
                def loc(r):
                  try (
                    (r.locations[0].physicalLocation.artifactLocation.uri // "n/a")
                    + ":" +
                    ((r.locations[0].physicalLocation.region.startLine // 0) | tostring)
                  ) catch "n/a";
                def rows(rs):
                  if (rs | length) == 0 then "_Êú¨Ê¨°Êâ´ÊèèÊú™ÂèëÁé∞ÈóÆÈ¢ò„ÄÇ_"
                  else "| Level | Rule | Location | Message |\n| --- | --- | --- | --- |\n" +
                    (rs | map("| " + lvl(.level // "unknown") + " | " +
                      (.ruleId // "Unknown") + " | " +
                      loc(.) + " | " +
                      (.message.text // "Unknown") + " |") | join("\n"))
                  end;
                ([ .[]? | .runs[]? | .results[]? ]) as $res
                | "# CodeQL\n\n" + rows($res)
              ' "${files[@]}" | tee codeql.md
            fi
          fi
          cat codeql.md >> "$GITHUB_STEP_SUMMARY"
          {
            echo 'codeql<<EOF'
            cat codeql.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Comment security summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          OSV_COMMENT: ${{ steps.osv_summary.outputs.osv }}
          CODEQL_COMMENT: ${{ steps.codeql_summary.outputs.codeql }}
          GITLEAKS_STATUS: ${{ steps.gitleaks.conclusion }}
        with:
          script: |
            const marker = '<!-- security-scan-report -->';
            const osv = process.env.OSV_COMMENT || '# OSV Scanner\n\n_Êó†ÂèØÁî®ËæìÂá∫„ÄÇ_';
            const codeql = process.env.CODEQL_COMMENT || '# CodeQL\n\n_Êó†ÂèØÁî®ËæìÂá∫„ÄÇ_';
            const gitleaksOutcome = process.env.GITLEAKS_STATUS || 'success';
            const gitleaks = gitleaksOutcome === 'success'
              ? 'Gitleaks: ‚úÖ Êó†Ê≥ÑÈú≤'
              : `Gitleaks: ‚ö†Ô∏è Ê£ÄÊµãÂà∞Áñë‰ººÊ≥ÑÈú≤ÔºàËØ¶ÊÉÖËßÅÊó•ÂøóÊàñÁîüÊàêÁöÑ artifactÔºâ„ÄÇ`;
            const body = `${marker}\n${gitleaks}\n\n${osv}\n\n---\n\n${codeql}`;

            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find((comment) =>
              comment.body && comment.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
