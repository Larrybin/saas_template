name: Security Scan

on:
  workflow_call:
    inputs:
      node-version:
        required: false
        type: string
        default: '20'
      pnpm-version:
        required: false
        type: string
        default: '9'
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - 'release/*'
    paths:
      - pnpm-lock.yaml
      - .github/workflows/security-scan.yml
  schedule:
    - cron: '0 2 * * 1'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ inputs.node-version }}
          pnpm-version: ${{ inputs.pnpm-version }}

      - name: Install dependencies (production)
        run: pnpm install --frozen-lockfile --prefer-offline --prod

      - name: Secret scan (gitleaks)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --no-banner --source . --verbose --redact --report-format sarif --report-path gitleaks.sarif

      - name: Upload gitleaks report
        uses: actions/upload-artifact@v5
        with:
          name: gitleaks-report
          path: gitleaks.sarif
          retention-days: 5

      - name: npm audit (high and critical)
        run: |
          set -eo pipefail
          pnpm audit --prod --audit-level high

      - name: npm audit (moderate warnings)
        run: |
          set -eo pipefail
          pnpm audit --prod --audit-level moderate || echo "::warning::Moderate vulnerabilities detected. Please review the audit output."

      - name: Check duplicate dependencies
        run: |
          set -e
          if pnpm dedupe --check; then
            echo "No duplicate dependencies found."
          else
            echo "::warning::Duplicate dependencies detected. Consider running 'pnpm dedupe'."
          fi

      - name: License compliance summary
        run: pnpm dlx license-checker --summary --excludePrivatePackages || echo "::warning::License checker reported issues."

      - name: OSV Scanner
        run: |
          set -euo pipefail
          OSV_VERSION='2.2.4'
          OSV_BIN_URL="https://github.com/google/osv-scanner/releases/download/v${OSV_VERSION}/osv-scanner_linux_amd64"
          curl -fsSL "$OSV_BIN_URL" -o osv-scanner
          chmod +x osv-scanner
          scan_status=0
          if ! ./osv-scanner --lockfile=pnpm-lock.yaml --format sarif --output osv-results.sarif; then
            scan_status=$?
          fi
          if [ "$scan_status" -eq 1 ]; then
            echo "::warning::OSV scanner detected vulnerabilities. Review osv-results.sarif for details."
          elif [ "$scan_status" -ne 0 ]; then
            exit "$scan_status"
          fi
          rm -f osv-scanner

      - name: Generate OSV PR summary
        id: osv_summary
        run: |
          set -euo pipefail
          if [ ! -s osv-results.sarif ]; then
            echo "# OSV Scanner\n\n_æœªç”ŸæˆæŠ¥å‘Šã€‚_" | tee osv-comment.md
          else
            jq -r '
              def severity_label(sev):
                if sev == "CRITICAL" then "ðŸš¨ Critical"
                elif sev == "HIGH" then "âš ï¸ High"
                elif sev == "MEDIUM" then "âš ï¸ Medium"
                elif sev == "LOW" then "â„¹ï¸ Low"
                else (sev // "Unknown")
                end;
              def severity_value(result):
                result.properties.severity // result.level // "UNKNOWN";
              def location_value(result):
                try result.locations[0].physicalLocation.artifactLocation.uri catch "n/a";
              def advisory_value(result):
                try result.properties.references[0].url catch "n/a";
              def result_row(result):
                "| " +
                severity_label(severity_value(result)) + " | " +
                (result.message.text // "Unknown") + " | " +
                location_value(result) + " | " +
                advisory_value(result) + " |";
              def rows(results):
                if results == null or (results | length) == 0 then "_æœ¬æ¬¡æ‰«ææœªå‘çŽ°æ¼æ´žã€‚_"
                else (
                  "| Severity | Package | Location | Advisory |\n| --- | --- | --- | --- |\n" +
                  (results | map(result_row(.)) | join("\n"))
                )
                end;
              "# OSV Scanner\n\n" + rows(.runs[0].results // [])
            ' osv-results.sarif | tee osv-comment.md
          fi

          cat osv-comment.md >> "$GITHUB_STEP_SUMMARY"
          {
            echo 'osv_body<<EOF'
            cat osv-comment.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Upload OSV report
        uses: actions/upload-artifact@v5
        with:
          name: osv-results
          path: osv-results.sarif
          retention-days: 5

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript

      - name: Perform CodeQL Analysis
        id: codeql_analyze
        uses: github/codeql-action/analyze@v4
        with:
          category: '/language:javascript-typescript'
          upload: false

      - name: Generate CodeQL summary
        id: codeql_summary
        env:
          CODEQL_SARIF: ${{ steps.codeql_analyze.outputs.sarif-output }}
        run: |
          set -euo pipefail
          sarif_file="${CODEQL_SARIF:-}"
          if [ -z "$sarif_file" ] || [ ! -s "$sarif_file" ]; then
            echo "# CodeQL\n\n_æœªç”ŸæˆæŠ¥å‘Šã€‚_" | tee codeql-comment.md
          else
            jq -r '
              def severity_label(sev):
                if sev == "error" then "ðŸš¨ Error"
                elif sev == "warning" then "âš ï¸ Warning"
                elif sev == "note" then "â„¹ï¸ Note"
                else sev
                end;
              def rows(results):
                if results == null or (results | length) == 0 then "_æœ¬æ¬¡æ‰«ææœªå‘çŽ°é—®é¢˜ã€‚_"
                else (
                  "| Level | Rule | Location | Message |\n| --- | --- | --- | --- |\n" +
                  (results | map(
                    "| " + severity_label(.level // "unknown") + " | " +
                    (.ruleId // "Unknown") + " | " +
                    (
                      try (
                        .locations[0].physicalLocation.artifactLocation.uri +
                        ":" +
                        (.locations[0].physicalLocation.region.startLine | tostring)
                      ) catch "n/a"
                    ) + " | " +
                    (.message.text // "Unknown") + " |"
                  ) | join("\n"))
                )
                end;
              "# CodeQL\n\n" + rows(.runs[0].results // [])
            ' "$sarif_file" | tee codeql-comment.md
          fi

          cat codeql-comment.md >> "$GITHUB_STEP_SUMMARY"
          {
            echo 'codeql_body<<EOF'
            cat codeql-comment.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Comment on PR with security findings
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- security-scan-report -->';
            const osv = process.env.OSV_COMMENT || '# OSV Scanner\n\n_æ— å¯ç”¨è¾“å‡ºã€‚_';
            const codeql = process.env.CODEQL_COMMENT || '# CodeQL\n\n_æ— å¯ç”¨è¾“å‡ºã€‚_';
            const finalBody = `${marker}\n${osv}\n\n---\n\n${codeql}`;
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find((comment) =>
              comment.body && comment.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body: finalBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: finalBody,
              });
            }
        env:
          OSV_COMMENT: ${{ steps.osv_summary.outputs.osv_body }}
          CODEQL_COMMENT: ${{ steps.codeql_summary.outputs.codeql_body }}
